{
  "version": 3,
  "sources": ["external-global:Serenity.Extensions", "../../../../../Modules/Administration/Translation/TranslationPage.ts", "../../../../../Modules/Administration/Translation/TranslationGrid.tsx"],
  "sourcesContent": ["module.exports = Serenity.Extensions;", "import { gridPageInit } from \"@serenity-is/corelib\";\nimport { TranslationGrid } from \"./TranslationGrid\";\n\nexport default () => gridPageInit(TranslationGrid);", "import { confirmDialog, EntityGrid, Fluent, GridUtils, isEmptyOrNull, isTrimmedEmpty, LookupEditor, LookupEditorOptions, notifySuccess, stripDiacritics, ToolButton, trimToEmpty, trimToNull, Widget } from \"@serenity-is/corelib\";\nimport { TranslationItem, TranslationTexts } from \"@serenity-is/extensions\";\nimport { Column } from \"@serenity-is/sleekgrid\";\nimport { TranslationService } from \"../../ServerTypes/Administration\";\nimport { nsAdministration } from \"../../ServerTypes/Namespaces\";\n\nexport class TranslationGrid extends EntityGrid<TranslationItem, any> {\n    static override[Symbol.typeInfo] = this.registerClass(nsAdministration);\n\n    protected override getIdProperty() { return \"Key\"; }\n    protected override getLocalTextPrefix() { return \"Administration.Translation\"; }\n    protected override getService() { return TranslationService.baseUrl; }\n\n    private hasChanges: boolean;\n    private searchText: string;\n    private sourceLanguage: LookupEditor;\n    private targetLanguage: LookupEditor;\n    private targetLanguageKey: string;\n\n    constructor(props: any) {\n        super(props);\n\n        this.element.on('keyup.' + this.uniqueName + ' change.' + this.uniqueName,\n            'input.custom-text', e => {\n                var value = trimToNull(Fluent(e.target).val());\n                if (value === '') {\n                    value = null;\n                }\n                this.view.getItemById(Fluent(e.target).data('key')).CustomText = value;\n                this.hasChanges = true;\n            });\n    }\n\n    protected override onClick(e: MouseEvent, row: number, cell: number): any {\n        super.onClick(e, row, cell);\n\n        if (e.defaultPrevented || (e as any)?.isDefaultPrevented?.()) {\n            return;\n        }\n\n        let item = this.itemAt(row);\n        let done: () => void;\n\n        if (Fluent(e.target).hasClass('source-text')) {\n            e.preventDefault();\n\n            done = () => {\n                item.CustomText = item.SourceText;\n                this.view.updateItem(item.Key, item);\n                this.hasChanges = true;\n            };\n\n            if (isTrimmedEmpty(item.CustomText) ||\n                (trimToEmpty(item.CustomText) === trimToEmpty(item.SourceText))) {\n                done();\n                return;\n            }\n\n            confirmDialog(TranslationTexts.OverrideConfirmation, done);\n            return;\n        }\n\n        if (Fluent(e.target).hasClass('target-text')) {\n            e.preventDefault();\n\n            done = () => {\n                item.CustomText = item.TargetText;\n                this.view.updateItem(item.Key, item);\n                this.hasChanges = true;\n            };\n\n            if (isTrimmedEmpty(item.CustomText) ||\n                (trimToEmpty(item.CustomText) === trimToEmpty(item.TargetText))) {\n                done();\n                return;\n            }\n\n            confirmDialog(TranslationTexts.OverrideConfirmation, done);\n            return;\n        }\n    }\n\n    protected override createColumns(): Column[] {\n\n        var columns: Column[] = [];\n        columns.push({\n            field: 'Key',\n            name: TranslationTexts.Key,\n            width: 300,\n            sortable: false\n        });\n\n        columns.push({\n            field: 'SourceText',\n            name: TranslationTexts.SourceText,\n            width: 300,\n            sortable: false,\n            format: ctx => <a class=\"source-text\">{ctx.value ?? ''}</a>\n        });\n\n        columns.push({\n            field: 'CustomText',\n            name: TranslationTexts.CustomText,\n            width: 300,\n            sortable: false,\n            format: ctx => <input class=\"custom-text\" value={ctx.value ?? ''} type=\"text\" placeholder={ctx.item.TargetText} data-key={ctx.item.Key} />\n        });\n\n        return columns;\n    }\n\n    protected override createToolbarExtensions(): void {\n        super.createToolbarExtensions();\n\n        let opt: LookupEditorOptions = {\n            lookupKey: 'Administration.Language'\n        };\n\n        this.sourceLanguage = Widget.create({\n            type: LookupEditor,\n            element: el => el.appendTo(this.toolbar.element).attr('placeholder', '--- ' +\n                TranslationTexts.SourceLanguage + ' ---'),\n            options: opt\n        });\n\n        this.sourceLanguage.changeSelect2(e => {\n            if (this.hasChanges) {\n                this.saveChanges(this.targetLanguageKey).then(() => this.refresh());\n            }\n            else {\n                this.refresh();\n            }\n        });\n\n        this.targetLanguage = Widget.create({\n            type: LookupEditor,\n            element: el => el.appendTo(this.toolbar.element).attr('placeholder', '--- ' +\n                TranslationTexts.TargetLanguage + ' ---'),\n            options: opt\n        });\n\n        this.targetLanguage.changeSelect2(e => {\n            if (this.hasChanges) {\n                this.saveChanges(this.targetLanguageKey).then(() => this.refresh());\n            }\n            else {\n                this.refresh();\n            }\n        });\n    }\n\n    protected saveChanges(language: string): PromiseLike<any> {\n        var translations: { [key: string]: string } = {};\n        for (let item of this.getItems()) {\n            translations[item.Key] = item.CustomText;\n        }\n\n        return Promise.resolve(TranslationService.Update({\n            TargetLanguageID: language,\n            Translations: translations\n        })).then(() => {\n            this.hasChanges = false;\n            language = trimToNull(language) || 'invariant';\n            notifySuccess('User translations in \"' + language +\n                '\" language are saved to \"user.texts.' +\n                language + '.json\" ' + 'file under \"~/App_Data/texts/\"', '');\n        });\n    }\n\n    protected override onViewSubmit(): boolean {\n        var request = this.view.params;\n        request.SourceLanguageID = this.sourceLanguage.value;\n        this.targetLanguageKey = this.targetLanguage.value || '';\n        request.TargetLanguageID = this.targetLanguageKey;\n        this.hasChanges = false;\n        return super.onViewSubmit();\n    }\n\n    protected override getButtons(): ToolButton[] {\n        return [{\n            title: TranslationTexts.SaveChangesButton,\n            onClick: e => this.saveChanges(this.targetLanguageKey).then(() => this.refresh()),\n            cssClass: 'apply-changes-button'\n        }];\n    }\n\n    protected override createQuickSearchInput() {\n        GridUtils.addQuickSearchInputCustom(this.toolbar.element,\n            (field, searchText) => {\n                this.searchText = searchText;\n                this.view.setItems(this.view.getItems(), true);\n            });\n    }\n\n    protected override onViewFilter(item: TranslationItem) {\n        if (!super.onViewFilter(item)) {\n            return false;\n        }\n\n        if (!this.searchText) {\n            return true;\n        }\n\n        var sd = stripDiacritics;\n        var searching = sd(this.searchText).toLowerCase();\n\n        function match(str: string) {\n            if (!str)\n                return false;\n\n            return str.toLowerCase().indexOf(searching) >= 0;\n        }\n\n        return isEmptyOrNull(searching) || match(item.Key) || match(item.SourceText) ||\n            match(item.TargetText) || match(item.CustomText);\n    }\n\n    protected override usePager() {\n        return false;\n    }\n}"],
  "mappings": "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",
  "names": ["require_Serenity", "__commonJSMin", "exports", "module", "import_corelib", "import_corelib", "import_extensions", "_a", "_b", "_TranslationGrid", "TranslationService", "props", "e", "value", "row", "cell", "item", "done", "__name", "columns", "ctx", "jsx", "opt", "el", "language", "translations", "request", "field", "searchText", "sd", "searching", "match", "str", "nsAdministration", "TranslationGrid", "TranslationPage_default", "__name", "TranslationGrid"]
}
